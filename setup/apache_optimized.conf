# Optimized Apache Configuration for Laravel Application
# This configuration is optimized for high-performance web applications

<VirtualHost *:80>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    DocumentRoot /var/www/html/nhit/public
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    DocumentRoot /var/www/html/nhit/public
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Enable mod_rewrite
    RewriteEngine On
    
    # Handle Laravel routes
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
    
    # Gzip Compression
    LoadModule deflate_module modules/mod_deflate.so
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
    
    # Browser Caching
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/ico "access plus 1 year"
        ExpiresByType image/icon "access plus 1 year"
        ExpiresByType text/plain "access plus 1 month"
        ExpiresByType application/pdf "access plus 1 month"
        ExpiresByType text/html "access plus 1 hour"
        ExpiresByType application/xhtml+xml "access plus 1 hour"
    </IfModule>
    
    # Cache Control Headers
    <IfModule mod_headers.c>
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
            Header set Cache-Control "max-age=31536000, public, immutable"
        </FilesMatch>
        <FilesMatch "\.(html|htm|php)$">
            Header set Cache-Control "max-age=3600, public"
        </FilesMatch>
    </IfModule>
    
    # Deny access to sensitive files
    <FilesMatch "^\.">
        Order allow,deny
        Deny from all
    </FilesMatch>
    
    <FilesMatch "\.(env|git|svn|hg|bzr)">
        Order allow,deny
        Deny from all
    </FilesMatch>
    
    <FilesMatch "\.(bak|backup|old|orig|original|tmp)$">
        Order allow,deny
        Deny from all
    </FilesMatch>
    
    # Security: Block common attack patterns
    <LocationMatch "/(wp-admin|wp-login|xmlrpc)">
        Order allow,deny
        Deny from all
    </LocationMatch>
    
    # Rate limiting (if mod_security is available)
    <IfModule mod_security2.c>
        SecRuleEngine On
        SecRule REQUEST_URI "@contains /backend/login" \
            "id:1001,phase:1,block,msg:'Rate limit exceeded',setvar:ip.rate_limit_counter=+1,expirevar:ip.rate_limit_counter=60,setvar:ip.rate_limit_counter=1"
    </IfModule>
    
    # PHP Configuration
    <IfModule mod_php8.c>
        php_value memory_limit 256M
        php_value max_execution_time 300
        php_value max_input_time 300
        php_value post_max_size 100M
        php_value upload_max_filesize 100M
        php_value max_file_uploads 20
        php_value session.gc_maxlifetime 7200
        php_value opcache.enable 1
        php_value opcache.memory_consumption 128
        php_value opcache.interned_strings_buffer 8
        php_value opcache.max_accelerated_files 4000
        php_value opcache.revalidate_freq 2
        php_value opcache.fast_shutdown 1
        php_value opcache.enable_cli 1
    </IfModule>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    
    # Performance settings
    <IfModule mod_mime.c>
        AddType application/javascript .js
        AddType text/css .css
    </IfModule>
    
    # Disable server signature
    ServerTokens Prod
    ServerSignature Off
    
    # Keep alive settings
    KeepAlive On
    KeepAliveTimeout 5
    MaxKeepAliveRequests 100
    
    # Timeout settings
    Timeout 300
    KeepAliveTimeout 5
</VirtualHost>

# Additional virtual host for static assets (optional)
<VirtualHost *:80>
    ServerName static.your-domain.com
    DocumentRoot /var/www/html/nhit/public
    
    <Location />
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </Location>
    
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|pdf|txt|tar|woff|woff2|ttf|eot|svg)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </FilesMatch>
</VirtualHost>
